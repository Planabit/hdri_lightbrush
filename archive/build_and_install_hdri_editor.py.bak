"""
Build and install script for HDRI Editor addon.
This script wil# Install the # 3. Install the addon using Blender's CLI
print("\nInstalling addon...")
install_script = f'''
import bpy
import sys

def install_addon():
    try:
        # Try to remove old version first
        try:
            bpy.ops.preferences.addon_remove(module="hdri_editor")
            print("Previous version removed successfully")
        except:
            print("No previous version found or unable to remove")
            
        # Install and enable new version
        bpy.ops.preferences.addon_install(filepath=r"{ADDON_ZIP}", overwrite=True)
        bpy.ops.preferences.addon_enable(module="hdri_editor")
        bpy.ops.wm.save_userpref()
        print("Addon installed and enabled successfully")
        return True
    except Exception as e:
        print(f"Error during installation: {{str(e)}}")
        return False

if not install_addon():
    sys.exit(1)
'''
print("\nInstalling addon...")
install_script = f'''
import bpy

# Try to remove old version first
try:
    bpy.ops.preferences.addon_remove(module="hdri_editor")
except Exception:
    print("Info: No previous version to remove or removal failed")

# Install and enable new version
bpy.ops.preferences.addon_install(filepath=r"{ADDON_ZIP}", overwrite=True)
bpy.ops.preferences.addon_enable(module="hdri_editor")
bpy.ops.wm.save_userpref()
'''zip file from the addon source
2. Close any running Blender instances
3. Install the addon in Blender
4. Restart Blender
"""

import os
import shutil
import subprocess
import sys
import time
from pathlib import Path

# CONFIGURATION
BLENDER_EXE = r"C:\Program Files\Blender Foundation\Blender 4.2\blender.exe"
ADDON_SRC = Path(__file__).parent.parent / 'hdri_editor'
ADDON_ZIP = ADDON_SRC.parent / 'hdri_editor.zip'

def clean_pycache(directory):
    """Remove all __pycache__ directories"""
    for root, dirs, files in os.walk(directory):
        for dir in dirs:
            if dir == "__pycache__":
                shutil.rmtree(os.path.join(root, dir))
                print(f"Cleaned: {os.path.join(root, dir)}")

# Clean __pycache__ directories first
print("Cleaning __pycache__ directories...")
clean_pycache(ADDON_SRC)

# 1. Zip the addon
print("\nCreating addon zip file...")
if ADDON_ZIP.exists():
    ADDON_ZIP.unlink()

# Create a temporary directory for correct zip structure
temp_dir = os.path.join(os.path.dirname(ADDON_ZIP), 'temp_build')
if os.path.exists(temp_dir):
    shutil.rmtree(temp_dir)
os.makedirs(temp_dir)

# Copy addon files to temp directory with correct structure
temp_addon_dir = os.path.join(temp_dir, 'hdri_editor')
shutil.copytree(ADDON_SRC, temp_addon_dir)

# Create zip from temp directory
zip_base = str(ADDON_ZIP).replace('.zip', '')
shutil.make_archive(zip_base, 'zip', temp_dir)
print(f"Addon zipped: {ADDON_ZIP}")

# Clean up temp directory
shutil.rmtree(temp_dir)

# 2. Close Blender (Windows only, closes all Blender instances)
print("\nClosing Blender instances...")
try:
    result = subprocess.run(['taskkill', '/IM', 'blender.exe', '/F'], 
                        capture_output=True, text=True, check=True)
    print("All Blender instances closed.")
except subprocess.CalledProcessError as e:
    if "ERROR: The process" in str(e.stderr) and "not found" in str(e.stderr):
        print("No Blender instances were running.")
    else:
        print(f"Error closing Blender: {e.stderr}")
time.sleep(2)

# 3. Install the addon using Blender's CLI
print("\nInstalling addon...")
install_script = f'''
import bpy

# Try to remove old version first
try:
    bpy.ops.preferences.addon_remove(module="hdri_editor")
except Exception as e:
    print(f"Info: No previous version to remove: {e}")

# Install and enable new version
bpy.ops.preferences.addon_install(filepath=r"{ADDON_ZIP}", overwrite=True)
bpy.ops.preferences.addon_enable(module="hdri_editor")
bpy.ops.wm.save_userpref()
'''

result = subprocess.run([
    BLENDER_EXE,
    "--background",
    "--python-expr",
    install_script
], capture_output=True, text=True)

if result.returncode != 0:
    print("Error installing addon:")
    if result.stderr:
        print(result.stderr)
    if result.stdout:
        print(result.stdout)
    sys.exit(1)
else:
    if result.stdout:
        print(result.stdout)
    print("Addon installed and enabled successfully.")

# 4. Restart Blender
print("\nStarting Blender...")
detached = subprocess.Popen([BLENDER_EXE])
print("Blender started successfully.")
